pipeline {
    agent any

    environment {
        IMAGE_BACKEND = "tyzer/backend"
        IMAGE_FRONTEND = "tyzer/frontend"
        DEPLOY_SERVER = "user@tyzer.top"
    }

    stages {
        stage('Clone Repository') {
            steps {
                git branch: 'main', credentialsId: 'gitlab-ci-token', url: 'https://gitlab.com/Tom8797438/scan_ticket.git'
            }
        }

        stage('Build Docker Images') {
            steps {
                script {
                    sh "docker build -t $IMAGE_BACKEND backend/"
                    sh "docker build -t $IMAGE_FRONTEND frontend/"
                    sh "docker tag $IMAGE_BACKEND tyzer.top:5000/backend"
                    sh "docker tag $IMAGE_FRONTEND tyzer.top:5000/frontend"
                }
            }
        }

        stage('Push Images to tyzer.top') {
            steps {
                script {
                    sh "docker login tyzer.top:5000 -u docker -p PASSWORD" // Ajoute un mot de passe s√©curis√©
                    sh "docker push tyzer.top:5000/backend"
                    sh "docker push tyzer.top:5000/frontend"
                }
            }
        }

        stage('Deploy on tyzer.top') {
            steps {
                script {
                    sh """
                    ssh -o StrictHostKeyChecking=no $DEPLOY_SERVER '
                        docker pull tyzer.top:5000/backend &&
                        docker pull tyzer.top:5000/frontend &&
                        docker-compose -f /path/to/docker-compose.yml up -d
                    '
                    """
                }
            }
        }
    }

    post {
        success {
            echo 'üöÄ D√©ploiement r√©ussi sur le Raspberry Pi !'
        }
        failure {
            echo '‚ùå √âchec du d√©ploiement, v√©rifie les logs.'
        }
    }
}
