image: docker:latest

variables:
  IMAGE_NAME: "registry.gitlab.com/Tom8797438/scan_ticket:latest"
  DOCKER_DRIVER: overlay2

stages:
  - test
  - build
  - deploy

# ğŸ› ï¸ Test de connexion au GitLab Registry
test_registry:
  stage: test
  services:
    - docker:dind
  script:
    - echo "ğŸ”‘ Connexion au GitLab Container Registry..."
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" registry.gitlab.com
    - echo "âœ… Connexion rÃ©ussie !"
  only:
    - main

# ğŸ”‘ Test de connexion SSH avant dÃ©ploiement
test_ssh:
  stage: test
  script:
    - echo "ğŸ”‘ Test de connexion SSH..."
    - apk add --no-cache openssh
    - ssh -o StrictHostKeyChecking=no -p $SSH_PORT $SSH_USER@$SSH_HOST "echo 'âœ… Connexion SSH rÃ©ussie'"
  only:
    - main

# ğŸ“¦ Build & Push de l'image Docker
build:
  stage: build
  services:
    - docker:dind
  script:
    - echo "ğŸ“¦ Construction de l'image Docker..."
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" registry.gitlab.com
    - docker build -t $IMAGE_NAME .
    - echo "ğŸ“¤ PoussÃ©e de l'image vers GitLab Registry..."
    - docker push $IMAGE_NAME
  only:
    - main

# ğŸš€ DÃ©ploiement sur le serveur Raspberry Pi
deploy:
  stage: deploy
  script:
    - echo "ğŸš€ DÃ©ploiement en cours sur $SSH_HOST..."
    - apk add --no-cache openssh
    - ssh -o StrictHostKeyChecking=no -p $SSH_PORT $SSH_USER@$SSH_HOST << 'EOF'
        docker pull $IMAGE_NAME
        docker stop mon-conteneur || true
        docker rm mon-conteneur || true
        docker run -d --name mon-conteneur -p 80:80 $IMAGE_NAME
    EOF
  only:
    - main
